generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TRIAL
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ACCESS
  EXPORT
  IMPORT
}

enum NotificationType {
  EMAIL
  IN_APP
  PUSH
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

model User {
  id                   String     @id @default(uuid())
  email                String     @unique
  password             String
  firstName            String     @map("first_name")
  lastName             String     @map("last_name")
  avatar               String?
  phone                String?
  status               UserStatus @default(PENDING_VERIFICATION)
  emailVerified        Boolean    @default(false) @map("email_verified")
  emailVerifiedAt      DateTime?  @map("email_verified_at")
  lastLoginAt          DateTime?  @map("last_login_at")
  refreshToken         String?    @map("refresh_token")
  passwordResetToken   String?    @map("password_reset_token")
  passwordResetExpires DateTime?  @map("password_reset_expires")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")
  deletedAt            DateTime?  @map("deleted_at")

  tenantMemberships TenantMember[]
  ownedTenants      Tenant[]       @relation("TenantOwner")
  auditLogs         AuditLog[]
  notifications     Notification[]
  sentInvitations   Invitation[]   @relation("InvitationSender")

  @@index([email])
  @@index([status])
  @@map("users")
}

model Tenant {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  domain      String?      @unique
  logo        String?
  description String?
  status      TenantStatus @default(TRIAL)
  settings    Json?        @default("{}")
  metadata    Json?        @default("{}")
  ownerId     String       @map("owner_id")
  owner       User         @relation("TenantOwner", fields: [ownerId], references: [id])
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  deletedAt   DateTime?    @map("deleted_at")

  members      TenantMember[]
  subscription Subscription?
  invitations  Invitation[]
  auditLogs    AuditLog[]
  apiKeys      ApiKey[]

  @@index([slug])
  @@index([ownerId])
  @@index([status])
  @@map("tenants")
}

model TenantMember {
  id        String   @id @default(uuid())
  role      Role     @default(MEMBER)
  isDefault Boolean  @default(false) @map("is_default")
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt  DateTime @default(now()) @map("joined_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_members")
}

model Subscription {
  id                   String             @id @default(uuid())
  tier                 SubscriptionTier   @default(FREE)
  status               SubscriptionStatus @default(TRIAL)
  trialStartsAt        DateTime?          @map("trial_starts_at")
  trialEndsAt          DateTime?          @map("trial_ends_at")
  startsAt             DateTime?          @map("starts_at")
  endsAt               DateTime?          @map("ends_at")
  cancelledAt          DateTime?          @map("cancelled_at")
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  stripePriceId        String?            @map("stripe_price_id")
  maxUsers             Int                @default(5) @map("max_users")
  maxProjects          Int                @default(3) @map("max_projects")
  maxStorage           BigInt             @default(1073741824) @map("max_storage")
  features             Json?              @default("[]")
  tenantId             String             @unique @map("tenant_id")
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  invoices Invoice[]
  payments Payment[]

  @@index([tenantId])
  @@index([tier])
  @@index([status])
  @@map("subscriptions")
}

model Invitation {
  id          String           @id @default(uuid())
  email       String
  role        Role             @default(MEMBER)
  token       String           @unique
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime         @map("expires_at")
  acceptedAt  DateTime?        @map("accepted_at")
  tenantId    String           @map("tenant_id")
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invitedById String           @map("invited_by_id")
  invitedBy   User             @relation("InvitationSender", fields: [invitedById], references: [id])
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@unique([tenantId, email])
  @@index([token])
  @@index([email])
  @@map("invitations")
}

model AuditLog {
  id         String      @id @default(uuid())
  action     AuditAction
  entityType String      @map("entity_type")
  entityId   String?     @map("entity_id")
  oldValues  Json?       @map("old_values")
  newValues  Json?       @map("new_values")
  metadata   Json?
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  userId     String?     @map("user_id")
  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  tenantId   String?     @map("tenant_id")
  tenant     Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String           @id @default(uuid())
  type      NotificationType
  title     String
  content   String
  data      Json?
  read      Boolean          @default(false)
  readAt    DateTime?        @map("read_at")
  userId    String           @map("user_id")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime         @default(now()) @map("created_at")

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model ApiKey {
  id          String    @id @default(uuid())
  name        String
  key         String    @unique
  hashedKey   String    @map("hashed_key")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  permissions Json?     @default("[]")
  tenantId    String    @map("tenant_id")
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([key])
  @@index([tenantId])
  @@map("api_keys")
}

model Invoice {
  id              String       @id @default(uuid())
  invoiceNumber   String       @unique @map("invoice_number")
  amount          Decimal      @db.Decimal(10, 2)
  currency        String       @default("USD")
  status          String       @default("draft")
  dueDate         DateTime     @map("due_date")
  paidAt          DateTime?    @map("paid_at")
  stripeInvoiceId String?      @map("stripe_invoice_id")
  subscriptionId  String       @map("subscription_id")
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

model Payment {
  id              String        @id @default(uuid())
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")
  status          PaymentStatus @default(PENDING)
  paymentMethod   String?       @map("payment_method")
  stripePaymentId String?       @map("stripe_payment_id")
  metadata        Json?
  subscriptionId  String        @map("subscription_id")
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([subscriptionId])
  @@index([status])
  @@map("payments")
}
